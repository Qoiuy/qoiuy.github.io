<!DOCTYPE html>
<html>
  <head>
    <title>Fastdfs – Lilac – A Novice Programmer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="简介
Copyright (C) 2008 Happy Fish / YuQing

" />
    <meta property="og:description" content="简介
Copyright (C) 2008 Happy Fish / YuQing

" />
    
    <meta name="author" content="Lilac" />

    
    <meta property="og:title" content="Fastdfs" />
    <meta property="twitter:title" content="Fastdfs" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="Lilac - A Novice Programmer" href="/feed.xml" />
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

  </head>

  <body>
    
    
    <div class="intro-header">    
      <div class="container">
        <div class="post-heading">
            <h1>Fastdfs</h1>
            <span class="meta">Posted by <a href="/about"> Lilac
            </a> on August 18, 2016
            <a href="/"> { Return to Blog }</a>
            </span>
        </div>
            
      </div>
    </div>
    

    <div id="main" role="main" class="container">
      <article class="post">
 <div class="space-extra-small">
 </div>

  <div class="entry">
    <h3 id="section">简介</h3>
<p>Copyright (C) 2008 Happy Fish / YuQing</p>

<p><a href="https://github.com/happyfish100/fastdfs">fastDFS源码</a></p>

<h3 id="section-1">与传统文件系统优点</h3>
<ul>
  <li>功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了<a href="">大容量存储</a>和<a href="">负载均衡</a>的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。</li>
  <li>FastDFS服务端有两个角色：跟踪器（tracker）和存储节点（storage）。
    <ul>
      <li>跟踪器（tracker）主要做调度工作，在访问上起负载均衡的作用。</li>
      <li>存储节点（storage）存储文件，完成文件管理的所有功能：存储、同步和提供存取接口，FastDFS同时对文件的meta data进行管理。所谓文件的meta data就是文件的相关属性，以键值对（key value pair）方式表示，如：width=1024，其中的key为width，value为1024。文件meta data是文件属性列表，可以包含多个键值对。</li>
    </ul>
  </li>
</ul>

<h3 id="fastdfs">fastdfs原理</h3>
<p><img src="/images/java/fastdfs01.png" alt="" /></p>

<h3 id="fastdfsjava">fastdfs在项目中的实际应用(java)</h3>

<h6 id="section-2">准备工作之搭建服务器（后面有）</h6>

<h6 id="fastdfs-1">准备工作之查看fastdfs是否启动</h6>
<p>查看图片<a href="http://192.168.200.128/group1/M00/00/01/wKjIgFWOYc6APpjAAAD-qk29i78248.jpg">网址</a>即可</p>

<h6 id="jarpomxml">准备工作之jar包(pom.xml)</h6>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;!-- FastDFS client --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;fastdfs_client&lt;/groupId&gt;
			&lt;artifactId&gt;fastdfs_client&lt;/artifactId&gt;
			&lt;version&gt;1.20&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.jboss.netty&lt;/groupId&gt;
			&lt;artifactId&gt;netty&lt;/artifactId&gt;
			&lt;version&gt;3.2.5.Final&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;
			&lt;artifactId&gt;dubbo&lt;/artifactId&gt;
			&lt;version&gt;2.5.3&lt;/version&gt;2
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;
			&lt;artifactId&gt;fastjson&lt;/artifactId&gt;
			&lt;version&gt;1.1.41&lt;/version&gt;
		&lt;/dependency&gt;
</code></pre>
</div>

<h6 id="resources">准备工作之配置全局配置文件(resources)</h6>
<p>fdfs_client.conf(参照jar包文件)</p>

<div class="highlighter-rouge"><pre class="highlight"><code># connect timeout in seconds
# default value is 30s
connect_timeout=30

# network timeout in seconds
# default value is 30s
network_timeout=60

# the base path to store log files
base_path=/home/fastdfs

# tracker_server can ocur more than once, and tracker_server format is
#  "host:port", host can be hostname or ip address
tracker_server=192.168.200.128:22122
#tracker_server=192.168.101.4:22122

#standard log level as syslog, case insensitive, value list:
### emerg for emergency
### alert
### crit for critical
### error
### warn for warning
### notice
### info
### debug
log_level=info

# if use connection pool
# default value is false
# since V4.05
use_connection_pool = false

# connections whose the idle time exceeds this time will be closed
# unit: second
# default value is 3600
# since V4.05
connection_pool_max_idle_time = 3600

# if load FastDFS parameters from tracker server
# since V4.05
# default value is false
load_fdfs_parameters_from_tracker=false

# if use storage ID instead of IP address
# same as tracker.conf
# valid only when load_fdfs_parameters_from_tracker is false
# default value is false
# since V4.05
use_storage_id = false

# specify storage ids filename, can use relative or absolute path
# same as tracker.conf
# valid only when load_fdfs_parameters_from_tracker is false
# since V4.05
storage_ids_filename = storage_ids.conf


#HTTP settings
http.tracker_server_port=80

#use "#include" directive to include HTTP other settiongs
##include http.conf
</code></pre>
</div>

<h6 id="fastdfsutilsjava-spring-common">使用自定义工具类FastDFSUtils实现上传（java-spring-common）</h6>
<p>自定义工具类</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/**
 * 连接FastDFS分布式文件系统
 * @author Lilac
 *
 */
public class FastDFSUtils {

    //上传图片　返回图片地址
    public static String uploadPic(byte[] pic,String name,long size) throws Exception{
        //FastDFS  原理：
        ClassPathResource resource = new ClassPathResource("fdfs_client.conf");
        ClientGlobal.init(resource.getClassLoader().getResource("fdfs_client.conf").getPath());
        //1：连接Tracker
        TrackerClient trackerClient = new TrackerClient();
        //2：获取Stoage的地址
        TrackerServer trackerServer = trackerClient.getConnection();
        //3：连接Stoage
        StorageServer storageServer = null;
        StorageClient1 storageClient1 = new StorageClient1(trackerServer,storageServer);
        //4：上传图片文件并获取url
        String ext = FilenameUtils.getExtension(name);

        NameValuePair[]  meta_list = new NameValuePair[3];
        //图片名
        meta_list[0] = new NameValuePair("filename",name);
        //图片 扩展名
        meta_list[1] = new NameValuePair("fileext",ext);
        //图片长度
        meta_list[2] = new NameValuePair("filesize",String.valueOf(size));
        //上传图片
        String path = storageClient1.upload_file1(pic, ext, meta_list);
        return path;
    }
}
</code></pre>
</div>

<p>jsp页面编写</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;form id="jvForm" action="edit.do" method="post"&gt;
	&lt;img width="100" height="100" id="allUrl" /&gt;
	&lt;input type="hidden" name="imgUrl" id="imgUrl"/&gt;
	&lt;input type="file" name="pic" onchange="uploadPic()"/&gt;
&lt;/form&gt;
</code></pre>
</div>

<p>js编写(使用jquery)</p>

<p><img src="/images/java/fastdfs02.png" alt="" /></p>

<p>配置springMVC(springMVC默认不支持上传图片)</p>

<p><img src="/images/java/fastdfs03.png" alt="" /></p>

<p>上传图片(java-spring-controller)</p>

<p><img src="/images/java/fastdfs04.png" alt="" /></p>

<p>上传图片(java-spring-service)</p>

<p><img src="/images/java/fastdfs05.png" alt="" /></p>

<p>上传图片之常量(java-spring-console)</p>

<p><img src="/images/java/fastdfs05.png" alt="" /></p>

<p>上传图片之BUG(response)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;!--强制依赖--&gt;
    &lt;dependencies&gt;
        &lt;!-- Tomcat7 servlet-api --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
            &lt;artifactId&gt;tomcat-jsp-api&lt;/artifactId&gt;
            &lt;version&gt;7.0.47&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
</div>

<p>上传图片之BUG(json字符串处理)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;!-- Jackson Json处理工具包 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
        &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
        &lt;version&gt;${jackson.version}&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre>
</div>

<p>######</p>

<h3 id="fastdfsclient120jar">fastdfs_client_1.20.jar分析</h3>

<h6 id="section-3">文件目录树</h6>
<div class="highlighter-rouge"><pre class="highlight"><code>.
├── fdfs_client.conf
├── META-INF
│   └── MANIFEST.MF
└── org
    └── csource
        ├── common
        │   ├── Base64.class
        │   ├── IniFileReader.class
        │   └── NameValuePair.class
        └── fastdfs
            ├── ClientGlobal.class
            ├── DownloadCallback.class
            ├── DownloadStream.class
            ├── FileInfo.class
            ├── ProtoCommon.class
            ├── ProtoCommon$RecvHeaderInfo.class
            ├── ProtoCommon$RecvPackageInfo.class
            ├── ProtoStructDecoder.class
            ├── ServerInfo.class
            ├── StorageClient1.class
            ├── StorageClient.class
            ├── StorageClient$UploadBuff.class
            ├── StorageServer.class
            ├── StructBase.class
            ├── StructBase$FieldInfo.class
            ├── StructGroupStat.class
            ├── StructStorageStat.class
            ├── test
            │   ├── DownloadFileWriter.class
            │   ├── Monitor.class
            │   ├── Test1.class
            │   ├── TestAppender1.class
            │   ├── TestAppender.class
            │   ├── Test.class
            │   ├── TestClient1.class
            │   ├── TestClient.class
            │   ├── TestLoad.class
            │   ├── TestLoad$Downloader.class
            │   ├── TestLoad$DownloadFileDiscard.class
            │   ├── TestLoad$DownloadThread.class
            │   ├── TestLoad$Uploader.class
            │   ├── TestLoad$UploadThread.class
            │   └── UploadLocalFileSender.class
            ├── TrackerClient.class
            ├── TrackerGroup.class
            ├── TrackerServer.class
            ├── UploadCallback.class
            └── UploadStream.class
</code></pre>
</div>

<h6 id="section-4">文件分析</h6>
<p>Tracker客户端连接fastdfs服务端　TrackerClient.class
Storage客户端连接fastdfs服务端　<a href="StorageClient.class已过时">StorageClient1.class</a>
fastdfs初始化　ClientGlobal.class
fastdfs全局配置文件　fdfs_client.conf
### 搭建fastdfs</p>

  </div>

  
</article>


    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
            <div class="svg-icon">
          
<a href="mailto:iszhanggc@163.com"><i class="icon-envelope icon-2x"></i></a>


<a href="https://github.com/Qoiuy"><i class="icon-github icon-2x"></i></a>








            </div>
        </footer>
      </div>
    </div>


    

  </body>
</html>
