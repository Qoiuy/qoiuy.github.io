---
layout: post
title: Activitiæºç éšæ‰‹è®°å½• Configuration
subtitle: éœ€è¦ä¸€ç›´æ›´æ–°çš„ä¸€ç¯‡æ–‡ç« 
date:  2019-08-20 09:26
header-img:  img/in-post/record-Activiti-Source-Snippet-0x02.jpg
---

<h1 id="record-activiti-source-snippet-0x02">Record Activiti Source Snippet 0x02</h1>
<p>psï¼šè¿™ç¯‡æ–‡ç« æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œ1.è¾¹ä¿®æ”¹è¾¹é‡æ–°å‘å¸ƒã€‚2åªå‘ä¸€ç‰ˆæœ€ç‰›bï¼Œæœ€ç‚«é…·çš„ã€‚é€‰å‰è€…</p>
<h3 id="impl.cfg">impl.cfg</h3>
<h3 id="processengineconfiguration">ProcessEngineConfiguration</h3>
<p>æœ€æœ‰åçš„ProcessEngineConfigurationçš„å­ç±»äº†ã€‚éƒ½ä¸Šäº†<a href="https://www.activiti.org/userguide/#configuration">userguide</a>äº†ã€‚ä»‹ç»ä»<a href="https://doc.yonyoucloud.com/doc/activiti-5.x-user-guide/Chapter%203.%20Configuration%20%E9%85%8D%E7%BD%AE/ProcessEngineConfiguration%20bean.html">5.xç¿»è¯‘</a> å¤åˆ¶è¿‡æ¥çš„ã€‚</p>
<p>å¯ä»¥è¯´æ˜¯æœ€æ ¸å¿ƒçš„ä¸€ä¸ªç±»äº†ï¼Œæ•´ä¸ªå¯åŠ¨activitiçš„è¿‡ç¨‹éƒ½åœ¨è¿™é‡Œã€‚æœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹ã€‚å¤§å¤šæ•°çš„initæ–¹æ³•éƒ½æ˜¯ä»¥if(null)ä½œä¸ºåˆ¤æ–­ã€‚è¿™æ ·å°±è¡¨ç¤ºï¼Œç”¨æˆ·ç«¯å¯ä»¥å®ç°å¤§é‡çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚</p>
<p>activitiå°†æ•´ä¸ªçš„å·¥ä½œæµæˆæ‹†åˆ†æˆè¿‘50ä¸ªæ¨¡å—ã€‚å¤§éƒ¨åˆ†æ¨¡å—éƒ½æ”¯æŒè‡ªå®šä¹‰è¡Œä¸ºã€‚ç£•å¤´è†œæ‹œï¼Œå­¦ä¹ </p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190819122708273.png" alt="" /><figcaption>image-20190819122708273</figcaption>
</figure>
<p>å¤šè¯´ä¸€å¥ å› ä¸ºæˆ‘ä¸ç”¨spring æ‰€ä»¥ä¸è¯»springç›¸å…³çš„ä»£ç ã€‚</p>
<p>ä¸‹é¢æ˜¯EngineConfigurationå­ç±»ä¹‹é—´çš„ç±»å›¾ã€‚</p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/JtaProcessEngineConfiguration.png" alt="" /><figcaption>JtaProcessEngineConfiguration</figcaption>
</figure>
<p>ç™½è¯æ–‡ç¿»è¯‘ - å¸¸è§„ä½¿ç”¨StandaloneProcessEngineConfiguration</p>
<ul>
<li><p>æµ‹è¯•ä½¿ç”¨StandaloneInMemProcessEngineConfiguration</p></li>
<li><p>JTA(Java Transaction API åˆ†å¸ƒå¼äº‹åŠ¡)éœ€æ±‚ä½¿ç”¨JtaProcessEngineConfiguration</p></li>
<li><p>å¤šç§Ÿæˆ·ä½¿ç”¨ MultiSchemaMultiTenantProcessEngineConfiguration</p></li>
</ul>
<p>å…¶å®ä¸»è¦é€»è¾‘éƒ½åœ¨ProcessEngineConfigurationå’ŒProcessEngineConfigurationImplä¸­ã€‚çœ‹ä»–ä»¬çš„filedså°±çŸ¥é“äº†ã€‚</p>
<p>å¤šäº†ä¸€ä¸ªMultiSchemaMultiTenantProcessEngineConfigurationæ²¡æœ‰åœ¨userguideä¸­ä»‹ç»ã€‚æºç ä¸­æ˜¯è¿™æ ·æ³¨é‡Šçš„ <img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190819123304252.png" alt="image-20190819123304252" /> æˆ‘å‚è€ƒäº†æœ‰é“ç¿»è¯‘çš„ç»“æœ</p>
<ul>
<li><p>ProcessEngineConfiguration æ„å»ºäº†ä¸€ä¸ªå¤šç§Ÿæˆ·ProcessEngineï¼Œå…¶ä¸­æ¯ä¸ªç§Ÿæˆ·éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“æ¨¡å¼ã€‚</p></li>
<li><p>å¦‚æœéœ€è¦å¤šç§Ÿæˆ·ä¸”ä¸éœ€è¦æ•°æ®éš”ç¦»:Activitiçš„é»˜è®¤ProcessEngineConfigurationImplæ˜¯é€šè¿‡åœ¨DeploymentBuilderä¸Šè®¾ç½®ç§Ÿæˆ·æ ‡è¯†ç¬¦å¯ç”¨å¤šç§Ÿæˆ·çš„ã€‚</p></li>
<li><h4 id="è¯¥é…ç½®å…·æœ‰ä»¥ä¸‹ç‰¹å¾">è¯¥é…ç½®å…·æœ‰ä»¥ä¸‹ç‰¹å¾:</h4>
<ul>
<li>å®ƒéœ€è¦ä¸€ä¸ªTenantInfoHolderæ¥ç¡®å®šå“ªä¸ªç§Ÿæˆ·å½“å‰æ˜¯â€œæ´»åŠ¨çš„â€ã€‚å³ä¸ºç§Ÿæˆ·æ‰§è¡Œç‰¹å®šçš„APIè°ƒç”¨ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨StrongUuidGeneratorã€‚â€œå¸¸è§„â€DbIdGeneratorä¸èƒ½ä¸æ­¤é…ç½®ä¸€èµ·ä½¿ç”¨ã€‚</li>
<li>ä½¿ç”¨registerTenant(String, DataSource)æ“ä½œæ·»åŠ æ‰¿ç§Ÿè€…(ä¹Ÿåœ¨å¼•å¯¼ä¹‹å)ã€‚</li>
<li>ç›®å‰ï¼Œè¯¥é…ç½®ä¸ä¸â€œæ—§çš„â€JobExecutorä¸€èµ·å·¥ä½œï¼Œä½†åªä¸è¾ƒæ–°çš„AsyncExecutorä¸€èµ·å·¥ä½œã€‚æœ‰ä¸¤ç§ä¸åŒçš„å®ç°:
<ul>
<li>ExecutorPerTenantAsyncExecutor:ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„AsyncExecutorã€‚</li>
<li>SharedExecutorServiceAsyncExecutor:ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºè·å–çº¿ç¨‹ï¼Œä½†ä½œä¸šæ‰§è¡Œæ˜¯ä½¿ç”¨æµç¨‹å¼•æ“å…±äº«ExecutorServiceå®Œæˆçš„ã€‚</li>
<li>AsyncExecutoréœ€è¦ä½¿ç”¨è¯¥ç±»ä¸Šçš„setAsyncExecutor(AsyncExecutor)æ–¹æ³•æ³¨å…¥ã€‚</li>
</ul></li>
</ul></li>
</ul>
<h5 id="init">init()</h5>
<p>è™½ç„¶å·²ç»æˆªå›¾äº†ã€‚ä½†è¿˜æ˜¯å¿ä¸ä½ç²˜ä»£ç </p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">// init</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">// /////////////////////////////////////////////////////////////////////</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>() {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="fu">initConfigurators</span>(); <span class="co">//åˆå§‹åŒ–é…ç½®å™¨ =&gt;è·å–åˆ°å…¨éƒ¨çš„configå¹¶å°è£…åœ¨allConfiguratorsé‡Œ</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">configuratorsBeforeInit</span>();<span class="co">//é…ç½®å™¨ä¹‹å‰åˆå§‹åŒ–</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">initProcessDiagramGenerator</span>();<span class="co">//æµç¨‹ å›¾ ç”Ÿæˆå™¨</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">initHistoryLevel</span>(); <span class="co">//åˆå§‹åŒ– History ç­‰çº§ è§HistoryLevelç±»</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">initExpressionManager</span>();<span class="co">//åˆå§‹åŒ–è¡¨è¾¾å¼ç®¡ç†å™¨</span></span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="kw">if</span> (usingRelationalDatabase) { <span class="co">//å¦‚æœä½¿ç”¨å…³ç³»å‹æ•°æ®åº“</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="fu">initDataSource</span>(); <span class="co">//åˆå§‹åŒ–æ•°æ®æº</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  }</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="fu">initAgendaFactory</span>(); <span class="co">//åˆå§‹åŒ–Agendaå·¥å‚</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="fu">initHelpers</span>(); <span class="co">//åˆå§‹åŒ–Helpers</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="fu">initVariableTypes</span>(); <span class="co">//åˆå§‹åŒ–å˜é‡ç±»å‹</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="fu">initBeans</span>(); <span class="co">//åˆå§‹åŒ– beans</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="fu">initFormEngines</span>();<span class="co">//åˆå§‹åŒ–formå¼•æ“</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="fu">initFormTypes</span>();<span class="co">//åˆå§‹åŒ–form</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="fu">initScriptingEngines</span>();<span class="co">//åˆå§‹åŒ–è„šæœ¬å¼•æ“</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="fu">initClock</span>();<span class="co">//åˆå§‹åŒ–æ—¶é’Ÿ</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="fu">initBusinessCalendarManager</span>();<span class="co">//åˆå§‹åŒ–ä¸šåŠ¡æ—¥ç¨‹ç®¡ç†å™¨</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>  <span class="fu">initCommandContextFactory</span>();<span class="co">//åˆå§‹åŒ– å‘½ä»¤ ä¸Šä¸‹æ–‡å·¥å‚</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="fu">initTransactionContextFactory</span>();<span class="co">//åˆå§‹åŒ– äº‹åŠ¡ä¸Šä¸‹æ–‡å·¥å‚</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="fu">initCommandExecutors</span>();<span class="co">//åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œå™¨</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>  <span class="fu">initServices</span>();<span class="co">//åˆå§‹åŒ–æœåŠ¡</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="fu">initIdGenerator</span>();<span class="co">//åˆå§‹åŒ–idç”Ÿæˆå™¨</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="fu">initBehaviorFactory</span>();<span class="co">//åˆå§‹åŒ–è¡Œä¸ºå·¥å‚</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>  <span class="fu">initListenerFactory</span>(); <span class="co">//åˆå§‹åŒ–ç›‘å¬å™¨å·¥å‚</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>  <span class="fu">initBpmnParser</span>();<span class="co">//åˆå§‹åŒ–bpmnè§£æå™¨</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>  <span class="fu">initProcessDefinitionCache</span>();<span class="co">//åˆå§‹åŒ–æµç¨‹å®šä¹‰cache</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>  <span class="fu">initProcessDefinitionInfoCache</span>();<span class="co">//åˆå§‹åŒ–æµç¨‹å®šä¹‰ä¿¡æ¯cache</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>  <span class="fu">initKnowledgeBaseCache</span>(); <span class="co">//åˆå§‹åŒ–çŸ¥è¯†åº“cache</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>  <span class="fu">initJobHandlers</span>();<span class="co">//åˆå§‹åŒ–jobå¤„ç†å™¨</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="fu">initJobManager</span>();<span class="co">//åˆå§‹åŒ–jobç®¡ç†å™¨</span></span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="fu">initAsyncExecutor</span>();<span class="co">//åˆå§‹åŒ–å¼‚æ­¥æ‰§è¡Œç¨‹åº</span></span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="fu">initTransactionFactory</span>();<span class="co">//åˆå§‹åŒ– äº‹åŠ¡å·¥å‚</span></span>
<span id="cb1-40"><a href="#cb1-40"></a></span>
<span id="cb1-41"><a href="#cb1-41"></a>  <span class="kw">if</span> (usingRelationalDatabase) {</span>
<span id="cb1-42"><a href="#cb1-42"></a>    <span class="fu">initSqlSessionFactory</span>();<span class="co">//åˆå§‹åŒ–sqlä¼šè¯å·¥å‚</span></span>
<span id="cb1-43"><a href="#cb1-43"></a>  }</span>
<span id="cb1-44"><a href="#cb1-44"></a></span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="fu">initSessionFactories</span>(); <span class="co">//åˆå§‹åŒ–ä¼šè¯å·¥å‚</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  <span class="fu">initDataManagers</span>(); <span class="co">//åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>  <span class="fu">initEntityManagers</span>(); <span class="co">//åˆå§‹åŒ– å®ä½“ç®¡ç†å™¨</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>  <span class="fu">initHistoryManager</span>(); <span class="co">//åˆå§‹åŒ– å†å²ç®¡ç†å™¨</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>  <span class="fu">initJpa</span>();<span class="co">//åˆå§‹åŒ–jpa</span></span>
<span id="cb1-50"><a href="#cb1-50"></a>  <span class="fu">initDeployers</span>();<span class="co">//åˆå§‹åŒ– éƒ¨ç½²è€…</span></span>
<span id="cb1-51"><a href="#cb1-51"></a>  <span class="fu">initDelegateInterceptor</span>();<span class="co">//åˆå§‹åŒ–å§”æ‰˜æ‹¦æˆªå™¨</span></span>
<span id="cb1-52"><a href="#cb1-52"></a>  <span class="fu">initEventHandlers</span>();<span class="co">//åˆå§‹åŒ–äº‹ä»¶ç®¡ç†å™¨</span></span>
<span id="cb1-53"><a href="#cb1-53"></a>  <span class="fu">initFailedJobCommandFactory</span>(); <span class="co">//åˆå§‹åŒ–æ•…éšœjob å‘½ä»¤å·¥å‚</span></span>
<span id="cb1-54"><a href="#cb1-54"></a>  <span class="fu">initEventDispatcher</span>();<span class="co">//åˆå§‹åŒ–äº‹ä»¶è°ƒåº¦å™¨</span></span>
<span id="cb1-55"><a href="#cb1-55"></a>  <span class="fu">initProcessValidator</span>();<span class="co">//åˆå§‹åŒ–è¿‡ç¨‹éªŒè¯å™¨</span></span>
<span id="cb1-56"><a href="#cb1-56"></a>  <span class="fu">initDatabaseEventLogging</span>(); <span class="co">//åˆå§‹åŒ–æ•°æ®åº“äº‹ä»¶æ—¥å¿—è®°å½•</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="fu">initActiviti5CompatibilityHandler</span>();<span class="co">//åˆå§‹åŒ–Activiti5å¤„ç†ç¨‹åºçš„å…¼å®¹æ€§</span></span>
<span id="cb1-58"><a href="#cb1-58"></a>  <span class="fu">configuratorsAfterInit</span>();<span class="co">//é…ç½®å™¨åˆå§‹åŒ–å</span></span>
<span id="cb1-59"><a href="#cb1-59"></a>}</span></code></pre></div>
<p>è¿™ä¸ªé‡è¦çš„æ–¹æ³• å¿ä¸ä½å’Œ5.0å¯¹æ¯”ä¸€ä¸‹ ã€‚æ•°æ®æºéƒ¨åˆ†ï¼Œæ–°å¢behavior,bomnparserç­‰</p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190820105847196.png" alt="" /><figcaption>image-20190820105847196</figcaption>
</figure>
<p>åˆå¿ä¸ä½å’Œ7.0å¯¹æ¯”ã€‚7.0åˆ é™¤äº†è¯¥æ–‡ä»¶ï¼Œåˆ é™¤äº†è¯¥æ–‡ï¼Œåˆ é™¤äº†è¯¥ï¼Œåˆ é™¤äº†ã€‚åˆ é™¤ã€‚åˆ ã€‚åˆ â€¦</p>
<h5 id="initconfigurators-è·å–åˆ°å…¨éƒ¨çš„config">initConfigurators() è·å–åˆ°å…¨éƒ¨çš„config</h5>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1"></a>  <span class="co">// 246L</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  </span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="kw">protected</span> <span class="dt">boolean</span> enableConfiguratorServiceLoader = <span class="kw">true</span>; <span class="co">// Enabled by default. In certain environments this should be set to false (eg osgi) é»˜è®¤å¯ç”¨ã€‚åœ¨æŸäº›ç¯å¢ƒä¸­ï¼Œè¿™åº”è¯¥è®¾ç½®ä¸ºfalse(å¦‚osgi)</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="kw">protected</span> <span class="bu">List</span>&lt;ProcessEngineConfigurator&gt; configurators; <span class="co">// The injected configurators æ³¨å…¥çš„é…ç½®å™¨</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="kw">protected</span> <span class="bu">List</span>&lt;ProcessEngineConfigurator&gt; allConfigurators; <span class="co">// Including auto-discovered configurators åŒ…æ‹¬é…ç½®å™¨è¿™é‡Œç”¨å¤„ä¸å¤§</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>  </span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="co">//1357L ä¼ªä»£ç </span></span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">initConfigurators</span>() {</span>
<span id="cb2-9"><a href="#cb2-9"></a>  </span>
<span id="cb2-10"><a href="#cb2-10"></a>      allConfigurators = <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;ProcessEngineConfigurator&gt;();</span>
<span id="cb2-11"><a href="#cb2-11"></a>  </span>
<span id="cb2-12"><a href="#cb2-12"></a>      <span class="co">// Configurators that are explicitly added to the config æ˜¾å¼æ·»åŠ åˆ°é…ç½®ä¸­çš„é…ç½®å™¨</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>      configurators.<span class="fu">forEach</span>(config -&gt; allConfigurators.<span class="fu">add</span>(config));</span>
<span id="cb2-14"><a href="#cb2-14"></a>    </span>
<span id="cb2-15"><a href="#cb2-15"></a>      <span class="co">// Auto discovery through ServiceLoader é€šè¿‡ServiceLoaderè‡ªåŠ¨å‘ç°</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>      <span class="kw">if</span> (enableConfiguratorServiceLoader) {</span>
<span id="cb2-17"><a href="#cb2-17"></a>  </span>
<span id="cb2-18"><a href="#cb2-18"></a>        <span class="co">//è·å–åˆ°classLoader</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>        <span class="bu">ClassLoader</span> classLoader = <span class="fu">getClassLoader</span>() == <span class="kw">null</span> ? ReflectUtil.<span class="fu">getClassLoader</span>() : <span class="fu">getClassLoader</span>();</span>
<span id="cb2-20"><a href="#cb2-20"></a>        </span>
<span id="cb2-21"><a href="#cb2-21"></a>        <span class="co">//ä½¿ç”¨ServiceLoaderåŠ è½½classLoader è·å–</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>        <span class="bu">ServiceLoader</span>&lt;ProcessEngineConfigurator&gt; configuratorServiceLoader = <span class="bu">ServiceLoader</span>.<span class="fu">load</span>(ProcessEngineConfigurator.<span class="fu">class</span>, classLoader);</span>
<span id="cb2-23"><a href="#cb2-23"></a>        </span>
<span id="cb2-24"><a href="#cb2-24"></a>        configuratorServiceLoader.<span class="fu">forEach</span>(config -&gt; allConfigurators.<span class="fu">add</span>(config))</span>
<span id="cb2-25"><a href="#cb2-25"></a>  </span>
<span id="cb2-26"><a href="#cb2-26"></a>        <span class="kw">if</span> (!allConfigurators.<span class="fu">isEmpty</span>()) {</span>
<span id="cb2-27"><a href="#cb2-27"></a>  </span>
<span id="cb2-28"><a href="#cb2-28"></a>          <span class="co">// Order them according to the priorities (useful for dependent</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>          <span class="co">// configurator) æ ¹æ®ä¼˜å…ˆçº§å¯¹å®ƒä»¬æ’åº(å¯¹ä¾èµ–é…ç½®å™¨æœ‰ç”¨)</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>          <span class="bu">Collections</span>.<span class="fu">sort</span>(allConfigurators)</span>
<span id="cb2-31"><a href="#cb2-31"></a>  </span>
<span id="cb2-32"><a href="#cb2-32"></a>          <span class="co">// Execute the configurators æ‰§è¡Œé…ç½®å™¨</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>        }</span>
<span id="cb2-34"><a href="#cb2-34"></a>  </span>
<span id="cb2-35"><a href="#cb2-35"></a>      }</span>
<span id="cb2-36"><a href="#cb2-36"></a>    }</span>
<span id="cb2-37"><a href="#cb2-37"></a>  </span></code></pre></div>
<h5 id="configuratorsbeforeinit-æ‰§è¡Œå…¨éƒ¨configç±»çš„initæ–¹æ³•">configuratorsBeforeInit() æ‰§è¡Œå…¨éƒ¨configç±»çš„initæ–¹æ³•</h5>
<p>ä»£ç ä¸€å…±å°±4è¡Œã€‚ä½†æ˜¯æ‰§è¡Œçš„å´æ˜¯å¾ˆå¤šè¡Œã€‚å‚è€ƒäº†<a href="https://blog.csdn.net/mmllllmm/article/details/80641070">å¤§ä½¬è¯´çš„</a>â€¦ä½œè€…è¿™æ ·è®¾è®¡configã€‚æƒ³æ³•ä¸ç®€å•å•Šã€‚å€¼å¾—è†œæ‹œå­¦ä¹ </p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">// éå†å…¨éƒ¨config å¹¶æ‰§è¡Œå…¨éƒ¨configçš„beforeInitæ–¹æ³•</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>allConfigurators.<span class="fu">forEach</span>(  config -&gt; config.<span class="fu">beforeInit</span>(<span class="kw">this</span>));</span></code></pre></div>
<h5 id="initprocessdiagramgenerator-drawå·¥ä½œæµå›¾ç‰‡">initProcessDiagramGenerator() drawå·¥ä½œæµå›¾ç‰‡</h5>
<p>ä»£ç ä¸€å…±ä¸‰è¡Œã€‚DefaultProcessDiagramGeneratorå¹¶ä¸æ˜¯Engineé¡¹ç›®ä¸­çš„ï¼Œè€Œæ˜¯activiti-image-generatoré¡¹ç›®ä¸­çš„ğŸ˜‚ è€Œactiviti-image-generatoré¡¹ç›®æ˜¯å°†ä¸€ä¸ªæµç¨‹ç”»å‡ºæ¥çš„ã€‚</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">if</span> (processDiagramGenerator == <span class="kw">null</span>) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  processDiagramGenerator = <span class="kw">new</span> <span class="fu">DefaultProcessDiagramGenerator</span>();</span>
<span id="cb4-3"><a href="#cb4-3"></a>}</span></code></pre></div>
<p>é¢ã€‚ä¸çŸ¥é“å•¥æ˜¯å·¥ä½œæµå›¾ç‰‡çš„çœ‹ä¸‹é¢è¿™ä¸ªå›¾ï¼Œå¦‚æœä½ è¿ä¸‹é¢è¿™å¼ å›¾ï¼Œæˆ–è€…ç±»ä¼¼çš„éƒ½æ²¡çœ‹è¿‡ã€‚ä½ å¯ä»¥é˜…è¯»ä¸‹ä¸€ç¯‡æ–‡ç« äº†ã€‚æˆ‘çš„è¿™ç¯‡å†…å®¹ä¸é€‚åˆä½ ã€‚</p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190820153747697.png" alt="" /><figcaption>image-20190820153747697</figcaption>
</figure>
<h5 id="inithistorylevel-å¤„ç†activitiçš„å†å²è®°å½•çº§åˆ«">initHistoryLevel() å¤„ç†activitiçš„å†å²è®°å½•çº§åˆ«</h5>
<p>ä¸‰è¡Œä»£ç </p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">if</span> (historyLevel == <span class="kw">null</span>) {</span>
<span id="cb5-2"><a href="#cb5-2"></a>      historyLevel = HistoryLevel.<span class="fu">getHistoryLevelForKey</span>(<span class="fu">getHistory</span>());</span>
<span id="cb5-3"><a href="#cb5-3"></a>}</span></code></pre></div>
<p><a href="https://www.activiti.org/userguide/#configurationRoot">å®˜ç½‘</a>æ˜¯è¿™æ ·ä»‹ç»historyLevelçš„ã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£ã€‚å¦‚æœä½ æƒ³ç”¨activitiçš„historyåŠŸèƒ½å°±é€‰åä¸¤ä¸ªï¼Œä¸æƒ³è®©activitiè®°å½•å†å²ï¼Œé‚£ä¹ˆå°±é€‰ä¸Šé¢ä¸¤ä¸ªï¼Œå¦‚æœä½ åŸæœ‰ç³»ç»Ÿä¸­å·²ç»åŒ…å«äº†historyï¼ŒçœŸçœŸä¸è¦ç”¨activitiçš„historyã€‚</p>
<p>Following history levels can be configured:</p>
<ul>
<li><p><code>none</code>: skips all history archiving. This is the most performant for runtime process execution, but no historical information will be available.è·³è¿‡æ‰€æœ‰å†å²å­˜æ¡£ã€‚è¿™æ˜¯è¿è¡Œæ—¶è¿›ç¨‹æ‰§è¡Œçš„æœ€ä½³æ€§èƒ½ï¼Œä½†æ˜¯æ²¡æœ‰å¯ç”¨çš„å†å²ä¿¡æ¯ã€‚</p></li>
<li><p><code>activity</code>: archives all process instances and activity instances. At the end of the process instance, the latest values of the top level process instance variables will be copied to historic variable instances. No details will be archived. å½’æ¡£æ‰€æœ‰æµç¨‹å®ä¾‹å’Œæ´»åŠ¨å®ä¾‹ã€‚åœ¨æµç¨‹å®ä¾‹çš„æœ«å°¾ï¼Œé¡¶å±‚æµç¨‹å®ä¾‹å˜é‡çš„æœ€æ–°å€¼å°†è¢«å¤åˆ¶åˆ°å†å²å˜é‡å®ä¾‹ä¸­ã€‚æ²¡æœ‰ä»»ä½•ç»†èŠ‚å°†è¢«å­˜æ¡£ã€‚</p></li>
<li><p><code>audit</code>: This is the default. It archives all process instances, activity instances, keeps variable values continuously in sync and all form properties that are submitted so that all user interaction through forms is traceable and can be audited.è¿™æ˜¯é»˜è®¤å€¼ã€‚å®ƒå½’æ¡£æ‰€æœ‰æµç¨‹å®ä¾‹ã€æ´»åŠ¨å®ä¾‹ã€ä¿æŒå˜é‡å€¼è¿ç»­åŒæ­¥ä»¥åŠæäº¤çš„æ‰€æœ‰è¡¨å•å±æ€§ï¼Œä»¥ä¾¿é€šè¿‡è¡¨å•è¿›è¡Œçš„æ‰€æœ‰ç”¨æˆ·äº¤äº’éƒ½æ˜¯å¯è·Ÿè¸ªçš„ï¼Œå¹¶ä¸”å¯ä»¥å®¡è®¡ã€‚</p></li>
<li><p><code>full</code>: This is the highest level of history archiving and hence the slowest. This level stores all information as in the <code>audit</code> level plus all other possible details, mostly this are process variable updates.è¿™æ˜¯æœ€é«˜çº§åˆ«çš„å†å²å­˜æ¡£ï¼Œå› æ­¤ä¹Ÿæ˜¯æœ€æ…¢çš„ã€‚æ­¤çº§åˆ«å­˜å‚¨ä¸â€œå®¡è®¡â€çº§åˆ«ç›¸åŒçš„æ‰€æœ‰ä¿¡æ¯ä»¥åŠæ‰€æœ‰å…¶ä»–å¯èƒ½çš„ç»†èŠ‚ï¼Œä¸»è¦æ˜¯æµç¨‹å˜é‡æ›´æ–°ã€‚</p></li>
</ul>
<h5 id="initexpressionmanager-elè¡¨è¾¾å¼">initExpressionManager() elè¡¨è¾¾å¼</h5>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">if</span> (expressionManager == <span class="kw">null</span>) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  expressionManager = <span class="kw">new</span> <span class="fu">ExpressionManager</span>(beans);</span>
<span id="cb6-3"><a href="#cb6-3"></a>}</span></code></pre></div>
<p>ç‚¹å‡»ExpressionManagerå®ç°ç±»çš„æ—¶å€™è·³è½¬åˆ°org.activiti.engine.impl.eläº†è¿™ä¸ªåŒ…ã€‚æˆ‘å°±äº†è§£äº†ã€‚</p>
<p>å¦‚æœä½ ä¸çŸ¥é“å“ªé‡Œç”¨äº†elè¡¨è¾¾å¼ï¼Œè¿™ä¸ªå°±æ˜¯</p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190820155625721.png" alt="" /><figcaption>image-20190820155625721</figcaption>
</figure>
<h5 id="initdatasource-åˆå§‹åŒ–æ•°æ®åº“è¿æ¥">initDataSource() åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</h5>
<p>ä»£ç ä¸å¤šã€‚æ”¯æŒäº†JNDIã€‚æ”¯æŒè‡ªå®šä¹‰ï¼Œå¤„ç†äº†Ibatisè¿æ¥close.åˆå§‹åŒ–äº†æ•°æ®çœ‹ç±»å‹.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">initDataSource</span>() {</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="kw">if</span> (dataSourceJndiName != <span class="kw">null</span>) {</span>
<span id="cb7-4"><a href="#cb7-4"></a>        <span class="co">//JNDI</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>        dataSource = (<span class="bu">DataSource</span>) <span class="kw">new</span> <span class="bu">InitialContext</span>().<span class="fu">lookup</span>(dataSourceJndiName);</span>
<span id="cb7-6"><a href="#cb7-6"></a>    } <span class="kw">else</span> <span class="kw">if</span> (jdbcUrl != <span class="kw">null</span>) {</span>
<span id="cb7-7"><a href="#cb7-7"></a>        PooledDataSource pooledDataSource = <span class="kw">new</span> <span class="fu">PooledDataSource</span>(...);</span>
<span id="cb7-8"><a href="#cb7-8"></a>        pooledDataSource.<span class="fu">set</span>...</span>
<span id="cb7-9"><a href="#cb7-9"></a>        dataSource = pooledDataSource;</span>
<span id="cb7-10"><a href="#cb7-10"></a>    }</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a>    <span class="kw">if</span> (dataSource <span class="kw">instanceof</span> PooledDataSource) {</span>
<span id="cb7-13"><a href="#cb7-13"></a>      <span class="co">// ACT-233: connection pool of Ibatis is not properly</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>      <span class="co">// initialized if this is not called!å¦‚æœæ²¡æœ‰è°ƒç”¨Ibatisè¿æ¥æ± ï¼Œåˆ™æœªæ­£ç¡®åˆå§‹åŒ–å®ƒ!</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>      ((PooledDataSource) dataSource).<span class="fu">forceCloseAll</span>();</span>
<span id="cb7-16"><a href="#cb7-16"></a>    }</span>
<span id="cb7-17"><a href="#cb7-17"></a>  }</span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="kw">if</span> (databaseType == <span class="kw">null</span>) {</span>
<span id="cb7-20"><a href="#cb7-20"></a>    <span class="fu">initDatabaseType</span>();</span>
<span id="cb7-21"><a href="#cb7-21"></a>  }</span>
<span id="cb7-22"><a href="#cb7-22"></a>}</span></code></pre></div>
<p>æˆ‘åœ¨è¿™é‡Œé‡åˆ°è¿‡ä¸€ä¸ªbugã€‚æˆ‘ä»¬å¯åŠ¨activitiä¹‹å ä¸ä¹…æ•°æ®åº“è¿æ¥å°±è¢«æ‰“æ»¡äº†ã€‚å°´å°¬ã€‚å¯èƒ½å°±æ˜¯å› ä¸ºè¿™é‡Œæ²¡æœ‰è¢«é‡Šæ”¾æ‰çš„åŸå› å§ã€‚å†è¯´å†è¯´ã€‚</p>
<h5 id="initagendafactory-æ²¡çœ‹æ‡‚">initAgendaFactory() â€¦æ²¡çœ‹æ‡‚</h5>
<p>è¯´å®è¯ ï¼Œæˆ‘ä¸€ç›´å¥½åƒæ²¡æœ‰ç”¨è¿‡Agendaã€‚ğŸ¶äº†ä¸€åœˆä¹Ÿæ²¡åˆå•¥æœ‰ç”¨çš„ç»“æœ</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">engineAgendaFactory</span> == <span class="kw">null</span>) {</span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="kw">this</span>.<span class="fu">engineAgendaFactory</span> = <span class="kw">new</span> <span class="fu">DefaultActivitiEngineAgendaFactory</span>();</span>
<span id="cb8-3"><a href="#cb8-3"></a>}</span></code></pre></div>
<p>è¿™æ ·å§ï¼Œçœ‹çœ‹Agendaä»£ç ä¸­çš„å®šä¹‰</p>
<ul>
<li>å¯¹äºæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªAPIè°ƒç”¨(ä»¥åŠCommand)ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°Agendaå®ä¾‹ã€‚</li>
<li>åœ¨è¿™ä¸ªAgendaä¸­ï¼Œå°†æ”¾ç½®æ“ä½œï¼ŒCommandExecutorå°†ç»§ç»­æ‰§è¡Œè¿™äº›æ“ä½œï¼Œç›´åˆ°æ‰€æœ‰æ“ä½œéƒ½æ‰§è¡Œå®Œæ¯•ã€‚</li>
<li>åœ¨ç¼–å†™ActivityBehaviorå®ç°æ—¶ï¼Œè¯¥è®®ç¨‹è¿˜å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®è®¡åˆ’æ–°æ“ä½œçš„æ–¹æ³•ã€‚</li>
<li>åœ¨å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œå§‹ç»ˆå¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡#getAgenda()è·å–Agendaã€‚</li>
</ul>
<p>è¿˜æ˜¯çœ‹ä¸æ‡‚ã€‚</p>
<h5 id="inithelpers-è¾…åŠ©ç±»">initHelpers() è¾…åŠ©ç±»</h5>
<p>åˆ›å»ºäº†processInstanceå’ŒlistenerNotificationçš„è¾…åŠ©ç±»</p>
<pre><code>if (processInstanceHelper == null) {
  processInstanceHelper = new ProcessInstanceHelper();
}
if (listenerNotificationHelper == null) {
  listenerNotificationHelper = new ListenerNotificationHelper();
}</code></pre>
<p>ä¸ºä»€ä¹ˆä¸æ˜¯é™æ€ç±»å‘¢ï¼Ÿ</p>
<h5 id="initvariabletypes-å˜é‡ç±»å‹">initVariableTypes() å˜é‡ç±»å‹</h5>
<p>activitiå°è£…äº†å˜é‡ç±»å‹äº†ï¼Œç±»åVariableType</p>
<h5 id="initbeans-æ²¡çœ‹æ‡‚">initBeans() â€¦æ²¡çœ‹æ‡‚</h5>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1"></a>beans = <span class="kw">new</span> <span class="bu">HashMap</span>&lt;<span class="bu">Object</span>, <span class="bu">Object</span>&gt;();</span></code></pre></div>
<h5 id="initformengines-formå¼•æ“-æ”¯æŒå®¢æˆ·ç«¯è‡ªå®šä¹‰">initFormEngines() formå¼•æ“ æ”¯æŒå®¢æˆ·ç«¯è‡ªå®šä¹‰</h5>
<p>formå¼•æ“åº”è¯¥æ˜¯ç”¨æ¥å¤„ç†formæµç¨‹èŠ‚ç‚¹çš„</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">if</span> (formEngines == <span class="kw">null</span>) {</span>
<span id="cb11-2"><a href="#cb11-2"></a>  formEngines = <span class="kw">new</span> <span class="bu">HashMap</span>&lt;<span class="bu">String</span>, FormEngine&gt;();</span>
<span id="cb11-3"><a href="#cb11-3"></a>  FormEngine defaultFormEngine = <span class="kw">new</span> <span class="fu">JuelFormEngine</span>();</span>
<span id="cb11-4"><a href="#cb11-4"></a>  formEngines.<span class="fu">put</span>(<span class="kw">null</span>, defaultFormEngine); <span class="co">// default form engine is</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>                                            <span class="co">// looked up with null ç‚¹ç›ä¹‹ç¬” å‰å®³äº† è†œæ‹œå­¦ä¹ </span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  formEngines.<span class="fu">put</span>(defaultFormEngine.<span class="fu">getName</span>(), defaultFormEngine);</span>
<span id="cb11-7"><a href="#cb11-7"></a>}</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="kw">if</span> (customFormEngines != <span class="kw">null</span>) {</span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="kw">for</span> (FormEngine formEngine : customFormEngines) {</span>
<span id="cb11-10"><a href="#cb11-10"></a>    formEngines.<span class="fu">put</span>(formEngine.<span class="fu">getName</span>(), formEngine);</span>
<span id="cb11-11"><a href="#cb11-11"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12"></a>}</span></code></pre></div>
<h5 id="initformtypes-formç±»å‹-æ”¯æŒå®¢æˆ·ç«¯è‡ªå®šä¹‰">initFormTypes() formç±»å‹ æ”¯æŒå®¢æˆ·ç«¯è‡ªå®šä¹‰</h5>
<h5 id="initscriptingengines-åˆå§‹åŒ–resolverå·¥å‚å’Œscriptingå¼•æ“">initScriptingEngines() åˆå§‹åŒ–resolverå·¥å‚å’Œscriptingå¼•æ“</h5>
<p>æˆ‘æ²¡ç”¨è¿‡scriptï¼Œå—¯</p>
<figure>
<img src="http://iszhanggc-private-blog.oss-cn-beijing.aliyuncs.com/img/mdpic/image-20190820174145211.png" alt="" /><figcaption>image-20190820174145211</figcaption>
</figure>
<h5 id="initclock-å¯¹æ—¶é—´çš„å°è£…æµç¨‹ä¸­å„ç§å®šæ—¶å™¨ä½¿ç”¨è¿™ä¸ªclock">initClock() å¯¹æ—¶é—´çš„å°è£…ï¼Œæµç¨‹ä¸­å„ç§å®šæ—¶å™¨ä½¿ç”¨è¿™ä¸ªclock</h5>
<h5 id="initbusinesscalendarmanager-å®šæ—¶ä»»åŠ¡ç®¡ç†å™¨">initBusinessCalendarManager() å®šæ—¶ä»»åŠ¡ç®¡ç†å™¨</h5>
<h5 id="initcommandcontextfactory-å‘½ä»¤contextå·¥å‚">initCommandContextFactory() å‘½ä»¤Contextå·¥å‚</h5>
<h5 id="inittransactioncontextfactory-äº‹åŠ¡contextå·¥å‚">initTransactionContextFactory() äº‹åŠ¡Contextå·¥å‚</h5>
<h5 id="initcommandexecutors-æ ¸å¿ƒ-åˆå§‹åŒ–å‘½ä»¤å¤„ç†å™¨">initCommandExecutors() æ ¸å¿ƒ åˆå§‹åŒ–å‘½ä»¤å¤„ç†å™¨</h5>
<p>è¯¥æ–¹æ³•å†…ç°ä½¿ç”¨ä¸€ä¸ªlistå­˜å‚¨ä¸€å †å‘½ä»¤æ‰§è¡Œå™¨ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å‰ç½®å‘½ä»¤å¤„ç†å™¨ï¼Œactivitiè‡ªå¸¦çš„å‘½ä»¤å¤„ç†å™¨ï¼Œå®¢æˆ·ç«¯è‡ªå®šä¹‰çš„å‘½ä»¤å¤„ç†å™¨ã€‚è¿™äº›å‘½ä»¤å¤„ç†å™¨ä¼šè¢«åˆå§‹åŒ–æˆä¸€ä¸ªé“¾å¼ç»“æ„ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰æ¥å¤„ç†æ‰€æœ‰å‘½ä»¤ã€‚ç”¨æˆ·å¤„ç†é™¤äº†å¯ä»¥è‡ªå®šä¹‰å‰ç½®å’Œè‡ªå®šä¹‰å¤„ç†å™¨ï¼Œè¿˜å¯ä»¥é€‰æ‹©</p>
<ul>
<li><p>activitiæ ¸å¿ƒå¤„ç†å™¨æ˜¯å¦è¿›å…¥debugæ¨¡å¼ï¼ˆè§initCommandInvokeræ–¹æ³•ï¼‰</p></li>
<li><p>é‡å†™äº‹åŠ¡å¤„ç†å™¨ ï¼ˆcreateTransactionInterceptoræŠ½è±¡æ–¹æ³•ï¼Œä¸”é‡å†™engineConfigurationï¼‰</p></li>
<li><p>é‡å†™å‘½ä»¤ä¸Šä¸‹æ–‡å·¥å‚ï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡å·¥å‚ï¼ˆåŸºæœ¬æ“ä½œï¼‰</p></li>
<li><p>æ˜¯å¦æ‰“å°debugæ—¥å¿— ï¼ˆLogInterceptoræœç´¢isDebugEnabledï¼‰</p></li>
</ul>
<p>è¿˜æœ‰å°±æ˜¯activitiçš„äº‹åŠ¡å¤„ç†è¿˜æœ‰è¶…æ—¶å¤„ç†çš„ä»£ç çš„å®ç°æ–¹å¼ æˆ‘ä¸æ˜¯å¤ªèµåŒï¼Œæ ¸å¿ƒçš„å‘½ä»¤æ‰§è¡Œå™¨ç«Ÿç„¶è¿˜æœ‰ä¸€ä¸ªtodoã€‚å—¯ï¼Œå·®ä¸å¤šè¿™äº›ã€‚</p>
<h5 id="initservices-æ ¸å¿ƒ-åˆå§‹åŒ–8ä¸­service">initServices() æ ¸å¿ƒ åˆå§‹åŒ–8ä¸­service</h5>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1"></a>  <span class="fu">initService</span>(repositoryService);</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">initService</span>(runtimeService);</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">initService</span>(historyService);</span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">initService</span>(identityService);</span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">initService</span>(taskService);</span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="fu">initService</span>(formService);</span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="fu">initService</span>(managementService);</span>
<span id="cb12-8"><a href="#cb12-8"></a>  <span class="fu">initService</span>(dynamicBpmnService);</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">//æ‰€æœ‰serviceæ‰§è¡ŒsetCommandExecutoræ–¹æ³•</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">initService</span>(<span class="bu">Object</span> service) {</span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="kw">if</span> (service <span class="kw">instanceof</span> ServiceImpl) {</span>
<span id="cb12-13"><a href="#cb12-13"></a>    ((ServiceImpl) service).<span class="fu">setCommandExecutor</span>(commandExecutor);</span>
<span id="cb12-14"><a href="#cb12-14"></a>  }</span>
<span id="cb12-15"><a href="#cb12-15"></a>}</span></code></pre></div>
<h5 id="initidgenerator-åˆå§‹åŒ–æ•°æ®åº“idç”Ÿæˆå™¨åº”è¯¥æ˜¯idè‡ªå¢ç›¸å…³çš„å§">initIdGenerator() åˆå§‹åŒ–æ•°æ®åº“Idç”Ÿæˆå™¨ï¼ˆåº”è¯¥æ˜¯idè‡ªå¢ç›¸å…³çš„å§ï¼‰</h5>
<p>åé¢çš„åˆå§‹åŒ–SessionFactorieséƒ¨åˆ†æœ‰ä½¿ç”¨</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">if</span> (idGenerator == <span class="kw">null</span>) {</span>
<span id="cb13-2"><a href="#cb13-2"></a>  CommandExecutor idGeneratorCommandExecutor = <span class="kw">null</span>;</span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="kw">if</span> (idGeneratorDataSource != <span class="kw">null</span>) {    </span>
<span id="cb13-4"><a href="#cb13-4"></a>    idGeneratorCommandExecutor = ...</span>
<span id="cb13-5"><a href="#cb13-5"></a>  } <span class="kw">else</span> <span class="kw">if</span> (idGeneratorDataSourceJndiName != <span class="kw">null</span>) {</span>
<span id="cb13-6"><a href="#cb13-6"></a>    idGeneratorCommandExecutor = ...</span>
<span id="cb13-7"><a href="#cb13-7"></a>  } <span class="kw">else</span> {</span>
<span id="cb13-8"><a href="#cb13-8"></a>    idGeneratorCommandExecutor = ...</span>
<span id="cb13-9"><a href="#cb13-9"></a>  }</span>
<span id="cb13-10"><a href="#cb13-10"></a></span>
<span id="cb13-11"><a href="#cb13-11"></a>  DbIdGenerator dbIdGenerator = <span class="kw">new</span> <span class="fu">DbIdGenerator</span>();</span>
<span id="cb13-12"><a href="#cb13-12"></a>  dbIdGenerator.<span class="fu">setIdBlockSize</span>(idBlockSize);</span>
<span id="cb13-13"><a href="#cb13-13"></a>  dbIdGenerator.<span class="fu">setCommandExecutor</span>(idGeneratorCommandExecutor);</span>
<span id="cb13-14"><a href="#cb13-14"></a>  dbIdGenerator.<span class="fu">setCommandConfig</span>(<span class="fu">getDefaultCommandConfig</span>().<span class="fu">transactionRequiresNew</span>());</span>
<span id="cb13-15"><a href="#cb13-15"></a>  idGenerator = dbIdGenerator;</span>
<span id="cb13-16"><a href="#cb13-16"></a>}</span></code></pre></div>
<h5 id="initbehaviorfactory-6.0-ä¸“å±-è¡Œä¸ºå·¥å‚">initBehaviorFactory() 6.0 ä¸“å± è¡Œä¸ºå·¥å‚</h5>
<p>activitybehaviorå·¥å‚çš„é»˜è®¤å®ç°ã€‚å½“ProcessEngineConfigurationImplä¸Šæ²¡æœ‰æ³¨å…¥è‡ªå®šä¹‰æ´»åŠ¨è¡Œä¸ºå·¥å‚æ—¶ä½¿ç”¨ã€‚</p>
<h5 id="initlistenerfactory-6.0-ä¸“å±-ç›‘å¬å·¥å‚">initListenerFactory() 6.0 ä¸“å± ç›‘å¬å·¥å‚</h5>
<p>ListenerFactoryçš„é»˜è®¤å®ç°</p>
<h5 id="initbpmnparser-6.0-ä¸“å±-bpmnè§£æå™¨">initBpmnParser() 6.0 ä¸“å± bpmnè§£æå™¨</h5>
<h5 id="initprocessdefinitioncache-6.0-ä¸“å±-æµç¨‹å®šä¹‰ç¼“å­˜åˆå§‹åŒ–">initProcessDefinitionCache() 6.0 ä¸“å± æµç¨‹å®šä¹‰ç¼“å­˜åˆå§‹åŒ–</h5>
<p>é»˜è®¤ç¼“å­˜:å°†æ‰€æœ‰å†…å®¹ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé™¤éè®¾ç½®äº†é™åˆ¶ã€‚initProcessDefinitionInfoCache() 6.0 ä¸“å±</p>
<h5 id="initknowledgebasecache-6.0-ä¸“å±-æµç¨‹ä¿¡æ¯ç¼“å­˜åˆå§‹åŒ–">initKnowledgeBaseCache() 6.0 ä¸“å± æµç¨‹ä¿¡æ¯ç¼“å­˜åˆå§‹åŒ–</h5>
<h5 id="initjobhandlers-ä¸€å †jobå¤„ç†å™¨">initJobHandlers() ä¸€å †jobå¤„ç†å™¨</h5>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1"></a>AsyncContinuationJobHandler asyncContinuationJobHandler = <span class="kw">new</span> <span class="fu">AsyncContinuationJobHandler</span>();</span>
<span id="cb14-2"><a href="#cb14-2"></a>jobHandlers.<span class="fu">put</span>(asyncContinuationJobHandler.<span class="fu">getType</span>(), asyncContinuationJobHandler);</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a>TriggerTimerEventJobHandler triggerTimerEventJobHandler = <span class="kw">new</span> <span class="fu">TriggerTimerEventJobHandler</span>();</span>
<span id="cb14-5"><a href="#cb14-5"></a>jobHandlers.<span class="fu">put</span>(triggerTimerEventJobHandler.<span class="fu">getType</span>(), triggerTimerEventJobHandler);</span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a>TimerStartEventJobHandler timerStartEvent = <span class="kw">new</span> <span class="fu">TimerStartEventJobHandler</span>();</span>
<span id="cb14-8"><a href="#cb14-8"></a>jobHandlers.<span class="fu">put</span>(timerStartEvent.<span class="fu">getType</span>(), timerStartEvent);</span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a>TimerSuspendProcessDefinitionHandler suspendProcessDefinitionHandler = <span class="kw">new</span> <span class="fu">TimerSuspendProcessDefinitionHandler</span>();</span>
<span id="cb14-11"><a href="#cb14-11"></a>jobHandlers.<span class="fu">put</span>(suspendProcessDefinitionHandler.<span class="fu">getType</span>(), suspendProcessDefinitionHandler);</span>
<span id="cb14-12"><a href="#cb14-12"></a></span>
<span id="cb14-13"><a href="#cb14-13"></a>TimerActivateProcessDefinitionHandler activateProcessDefinitionHandler = <span class="kw">new</span> <span class="fu">TimerActivateProcessDefinitionHandler</span>();</span>
<span id="cb14-14"><a href="#cb14-14"></a>jobHandlers.<span class="fu">put</span>(activateProcessDefinitionHandler.<span class="fu">getType</span>(), activateProcessDefinitionHandler);</span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16"><a href="#cb14-16"></a>ProcessEventJobHandler processEventJobHandler = <span class="kw">new</span> <span class="fu">ProcessEventJobHandler</span>();</span>
<span id="cb14-17"><a href="#cb14-17"></a>jobHandlers.<span class="fu">put</span>(processEventJobHandler.<span class="fu">getType</span>(), processEventJobHandler);</span></code></pre></div>
<h5 id="initjobmanager-jobç®¡ç†å™¨">initJobManager(); jobç®¡ç†å™¨</h5>
<p>åŒ…å«ä¸ç»‘å®šåˆ°ä»»ä½•ç‰¹å®šä½œä¸šç±»å‹(å¼‚æ­¥ã€å®šæ—¶å™¨ã€æŒ‚èµ·æˆ–æ­»ä¿¡)çš„æ–¹æ³•ï¼Œä½†é€šå¸¸é€‚ç”¨äºä»ä¸€ç§ç±»å‹è½¬æ¢åˆ°å¦ä¸€ç§ç±»å‹ã€‚</p>
<h5 id="initasyncexecutor-å¼‚æ­¥å¤„ç†å™¨-å¼±å°çš„æˆ‘ç‘Ÿç‘Ÿå‘æŠ–..çœŸçš„çœ‹ä¸æ‡‚">initAsyncExecutor(); å¼‚æ­¥å¤„ç†å™¨ â€¦å¼±å°çš„æˆ‘ç‘Ÿç‘Ÿå‘æŠ–..çœŸçš„çœ‹ä¸æ‡‚</h5>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1"></a>DefaultAsyncJobExecutor defaultAsyncExecutor = <span class="kw">new</span> <span class="fu">DefaultAsyncJobExecutor</span>();</span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="co">// Message queue mode</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  defaultAsyncExecutor.<span class="fu">setMessageQueueMode</span>(asyncExecutorMessageQueueMode);</span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="co">// Thread pool config</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  defaultAsyncExecutor.<span class="fu">setCorePoolSize</span>(asyncExecutorCorePoolSize);</span>
<span id="cb15-8"><a href="#cb15-8"></a>  defaultAsyncExecutor.<span class="fu">setMaxPoolSize</span>(asyncExecutorMaxPoolSize);</span>
<span id="cb15-9"><a href="#cb15-9"></a>  defaultAsyncExecutor.<span class="fu">setKeepAliveTime</span>(asyncExecutorThreadKeepAliveTime);</span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="co">// Threadpool queue</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="kw">if</span> (asyncExecutorThreadPoolQueue != <span class="kw">null</span>) {</span>
<span id="cb15-13"><a href="#cb15-13"></a>    defaultAsyncExecutor.<span class="fu">setThreadPoolQueue</span>(asyncExecutorThreadPoolQueue);</span>
<span id="cb15-14"><a href="#cb15-14"></a>  }</span>
<span id="cb15-15"><a href="#cb15-15"></a>  defaultAsyncExecutor.<span class="fu">setQueueSize</span>(asyncExecutorThreadPoolQueueSize);</span>
<span id="cb15-16"><a href="#cb15-16"></a></span>
<span id="cb15-17"><a href="#cb15-17"></a>  <span class="co">// Acquisition wait time</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>  defaultAsyncExecutor.<span class="fu">setDefaultTimerJobAcquireWaitTimeInMillis</span>(asyncExecutorDefaultTimerJobAcquireWaitTime);</span>
<span id="cb15-19"><a href="#cb15-19"></a>  defaultAsyncExecutor.<span class="fu">setDefaultAsyncJobAcquireWaitTimeInMillis</span>(asyncExecutorDefaultAsyncJobAcquireWaitTime);</span>
<span id="cb15-20"><a href="#cb15-20"></a></span>
<span id="cb15-21"><a href="#cb15-21"></a>  <span class="co">// Queue full wait time</span></span>
<span id="cb15-22"><a href="#cb15-22"></a>  defaultAsyncExecutor.<span class="fu">setDefaultQueueSizeFullWaitTimeInMillis</span>(asyncExecutorDefaultQueueSizeFullWaitTime);</span>
<span id="cb15-23"><a href="#cb15-23"></a></span>
<span id="cb15-24"><a href="#cb15-24"></a>  <span class="co">// Job locking</span></span>
<span id="cb15-25"><a href="#cb15-25"></a>  defaultAsyncExecutor.<span class="fu">setTimerLockTimeInMillis</span>(asyncExecutorTimerLockTimeInMillis);</span>
<span id="cb15-26"><a href="#cb15-26"></a>  defaultAsyncExecutor.<span class="fu">setAsyncJobLockTimeInMillis</span>(asyncExecutorAsyncJobLockTimeInMillis);</span>
<span id="cb15-27"><a href="#cb15-27"></a>  <span class="kw">if</span> (asyncExecutorLockOwner != <span class="kw">null</span>) {</span>
<span id="cb15-28"><a href="#cb15-28"></a>    defaultAsyncExecutor.<span class="fu">setLockOwner</span>(asyncExecutorLockOwner);</span>
<span id="cb15-29"><a href="#cb15-29"></a>  }</span>
<span id="cb15-30"><a href="#cb15-30"></a></span>
<span id="cb15-31"><a href="#cb15-31"></a>  <span class="co">// Reset expired</span></span>
<span id="cb15-32"><a href="#cb15-32"></a>  defaultAsyncExecutor.<span class="fu">setResetExpiredJobsInterval</span>(asyncExecutorResetExpiredJobsInterval);</span>
<span id="cb15-33"><a href="#cb15-33"></a>  defaultAsyncExecutor.<span class="fu">setResetExpiredJobsPageSize</span>(asyncExecutorResetExpiredJobsPageSize);</span>
<span id="cb15-34"><a href="#cb15-34"></a></span>
<span id="cb15-35"><a href="#cb15-35"></a>  <span class="co">// Shutdown</span></span>
<span id="cb15-36"><a href="#cb15-36"></a>  defaultAsyncExecutor.<span class="fu">setSecondsToWaitOnShutdown</span>(asyncExecutorSecondsToWaitOnShutdown);</span>
<span id="cb15-37"><a href="#cb15-37"></a></span>
<span id="cb15-38"><a href="#cb15-38"></a>  asyncExecutor = defaultAsyncExecutor;</span>
<span id="cb15-39"><a href="#cb15-39"></a>}</span></code></pre></div>
<h5 id="inittransactionfactory-åˆå§‹åŒ–äº‹åŠ¡å·¥å‚-é»˜è®¤æä¾›ä¸¤ç§">initTransactionFactory() åˆå§‹åŒ–äº‹åŠ¡å·¥å‚ é»˜è®¤æä¾›ä¸¤ç§</h5>
<pre class="javaÂ "><code>if (transactionsExternallyManaged) {
  transactionFactory = new ManagedTransactionFactory();
} else {
  transactionFactory = new JdbcTransactionFactory();
}</code></pre>
<h5 id="initsqlsessionfactory-å‰æä½¿ç”¨å…³ç³»å‹æ•°æ®åº“">initSqlSessionFactory() å‰æï¼šä½¿ç”¨å…³ç³»å‹æ•°æ®åº“</h5>
<p>åˆå§‹åŒ–mybatis sqlsession</p>
<h5 id="initsessionfactories-åˆå§‹åŒ–sql-sessionå·¥å‚">initSessionFactories() åˆå§‹åŒ–sql sessionå·¥å‚</h5>
<h5 id="initdatamanagers-åˆå§‹åŒ–mappers">initDataManagers() åˆå§‹åŒ–mappers</h5>
<p>mybatisä½¿ç”¨çš„mapper</p>
<h5 id="initentitymanagers-åˆå§‹åŒ–å®ä½“">initEntityManagers() åˆå§‹åŒ–å®ä½“</h5>
<h5 id="inithistorymanager-åˆå§‹åŒ–historymapper-å¸¦æœ‰historylevel">initHistoryManager() åˆå§‹åŒ–historymapper å¸¦æœ‰historyLevel</h5>
<h5 id="initjpaåˆå§‹åŒ–jpa">initJpa();åˆå§‹åŒ–jpa</h5>
<h5 id="initdeployersåˆå§‹åŒ–deploymentmanagerä¸­çš„cacheç­‰">initDeployers()åˆå§‹åŒ–deploymentManagerä¸­çš„cacheç­‰</h5>
<h5 id="initdelegateinterceptoråˆå§‹åŒ–-å§”æ‰˜æ‹¦æˆªå™¨">initDelegateInterceptor()åˆå§‹åŒ– å§”æ‰˜æ‹¦æˆªå™¨</h5>
<h5 id="initeventhandlers-åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨">initEventHandlers() åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨</h5>
<h5 id="initfailedjobcommandfactory-å¤±è´¥çš„jobå‘½ä»¤å·¥å‚">initFailedJobCommandFactory() å¤±è´¥çš„jobå‘½ä»¤å·¥å‚</h5>
<h5 id="initeventdispatcher-åˆå§‹åŒ–äº‹ä»¶è°ƒåº¦å™¨">initEventDispatcher() åˆå§‹åŒ–äº‹ä»¶è°ƒåº¦å™¨</h5>
<h5 id="initprocessvalidator-åˆå§‹åŒ–è¿‡ç¨‹éªŒè¯å™¨">initProcessValidator() åˆå§‹åŒ–è¿‡ç¨‹éªŒè¯å™¨</h5>
<h5 id="initdatabaseeventlogging-æ•°æ®åº“äº‹ä»¶è®°å½•å™¨">initDatabaseEventLogging() æ•°æ®åº“äº‹ä»¶è®°å½•å™¨</h5>
<h5 id="initactiviti5compatibilityhandler-activiti5å…¼å®¹å¤„ç†å™¨">initActiviti5CompatibilityHandler() activiti5å…¼å®¹å¤„ç†å™¨</h5>
<h5 id="configuratorsafterinit">configuratorsAfterInit()</h5>
